# 任务拆分与UI显示 - 快速解答

## 你的问题

> 1. 如何根据大模型提示词将大型任务拆分成多个子任务？
> 2. UI面板没有显示，可以用树状显示或折叠模式

## 快速回答

### Q1: 大模型如何拆分任务？

**当前机制**:

Roo-Code有**两种**任务拆分方式：

#### 方式1: TODO列表 (`update_todo_list` 工具)

```typescript
// 轻量级任务跟踪，所有步骤在同一个任务中
<update_todo_list>
<todos>
[x] 分析需求
[-] 实现功能 ← 当前
[ ] 编写测试
[ ] 更新文档
</todos>
</update_todo_list>
```

**特点**:

- ✅ 简单轻量
- ✅ 实时更新进度
- ❌ 不能并行执行
- ❌ 所有步骤共享一个上下文

#### 方式2: 子任务 (`new_task` 工具)

```typescript
// 创建独立的子任务实例
<new_task>
<mode>architect</mode>
<message>设计系统架构...</message>
<todos>
[ ] 设计数据模型
[ ] 定义API接口
</todos>
</new_task>
```

**特点**:

- ✅ 完全隔离的上下文
- ✅ 可切换不同模式
- ✅ 维护父子关系
- ❌ 串行执行（父任务等待子任务）

**当前问题**:

🔴 **提示词中缺少明确指导** - 大模型不知道何时该用哪种方式！

现有提示词只告诉大模型"将任务分解为步骤"，但没说：

- 何时用TODO列表 vs 何时创建子任务
- 如何判断任务是否需要模式切换
- 如何决定是否需要上下文隔离

**解决方案**:

在系统提示词中添加决策指导：

```markdown
## Task Decomposition Strategy

### 使用 TODO列表 (update_todo_list) 当:

- 任务可以在**同一模式**内完成
- 所有步骤共享相同上下文
- 不需要切换模式
- 例如: "实现登录功能" (全部在code模式)

### 创建子任务 (new_task) 当:

- 需要**切换模式** (architect → code → test)
- 任务有明确分离的阶段
- 需要独立的上下文
- 例如: "设计并实现API" (先architect设计，再code实现)

### 混合方式:

- 每个子任务内部使用TODO列表跟踪进度
- 主任务通过子任务来分阶段执行
```

---

### Q2: UI如何显示任务层级？

**当前状态**:

❌ TODO列表只是扁平的文本，看不到层级关系
❌ 子任务关系不可见
❌ 没有进度指示器

**改进方案**:

#### 方案A: 简单折叠模式（快速实现）

在环境详情中改进显示：

```
# Current Task Progress
Progress: 60% (3/5 completed) ████████░░

▼ 进行中 (1)
  ⚙️ 实现JWT验证

▼ 待办 (1)
  📋 编写测试

▽ 已完成 (3) [点击展开]
```

#### 方案B: 树状层级显示（完整方案）

```
📊 任务层级 (60% 完成)

└─ 🎯 实现用户认证系统 (根任务)
   ├─ ✅ 子任务: 设计架构 (architect) - 已完成
   │  ├─ [x] 设计数据模型
   │  ├─ [x] 定义API接口
   │  └─ [x] 编写文档
   │
   ├─ ⚙️ 子任务: 实现后端 (code) - 进行中
   │  ├─ [x] 用户注册
   │  ├─ [x] 登录功能
   │  ├─ [-] JWT验证 ← 当前
   │  └─ [ ] 单元测试
   │
   └─ 📋 待创建: 编写API文档
```

**实施位置**:

1. **环境详情增强** (`src/core/environment/reminder.ts`)

    - 添加进度百分比计算
    - 按状态分组显示TODO
    - 显示任务层级信息

2. **UI组件** (`webview-ui/src/components/TaskProgress/`)
    - 创建可折叠的任务进度组件
    - 显示树状结构
    - 支持点击展开/折叠

---

## 实施优先级

### 🔥 P0 - 立即可做（无需代码）

1. 修改提示词 - 添加任务拆分决策指导
2. 增强 `new_task` 工具描述

### 🔨 P1 - 短期（1-2周）

3. 改进环境详情显示格式
4. 添加进度百分比和分组

### 🚀 P2 - 中期（1个月）

5. 实现UI折叠组件
6. 显示完整任务树

---

## 核心要点

1. **大模型能力**: 大模型**已经能够**拆分任务，只是缺少明确的选择指导

2. **两种方式的本质区别**:

    - TODO列表 = 任务内的步骤跟踪
    - 子任务 = 创建新的独立任务实例

3. **何时用哪个**:

    - 同一模式内 → TODO列表
    - 需要切换模式 → 子任务
    - 复杂项目 → 混合使用

4. **UI改进核心**:
    - 进度可视化（百分比、进度条）
    - 层级结构（树状、折叠）
    - 状态分组（进行中、待办、已完成）

---

## 详细文档

完整的分析、代码示例和实施方案，请参考：

📄 [`docs/32-task-decomposition-and-ui-display.md`](docs/32-task-decomposition-and-ui-display.md)

该文档包含：

- 现有机制的深入分析
- 大模型行为模式详解
- 完整的UI改进方案
- 代码实现示例
- 分阶段实施计划

---

**创建时间**: 2025-10-12  
**相关文档**: docs/07-task-lifecycle.md, docs/08-prompts-system.md, docs/14-multi-agent-collaboration-system.md
