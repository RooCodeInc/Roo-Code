# Roo Cline スタンドアロンWebアプリ化実装方針

## 1. プロジェクト概要

VS Code拡張として実装されているRoo ClineのwebviewをスタンドアロンのWebアプリとして切り出し、独自に運用できるようにする。同時にオリジナルのRoo Clineからの更新も取り込める形で維持する。

### 目的
- VS Code拡張に依存しない形でWebアプリとして動作させる
- 独自の機能拡張や改修を可能にする
- オリジナルの更新を継続的に取り込める体制を整える

## 2. 具体的な実装ステップ

### Phase 1: 環境セットアップ
1. 依存パッケージのインストール
```bash
pnpm install
cd webview-ui && pnpm install
cd ..
```

### Phase 2: VS Code依存の切り離し

1. **VS Code API のモック化**
   - `webview-ui/src/utils/vscode.ts` の修正
   - `postMessage` 関数の抽象化
   - `acquireVsCodeApi` の参照箇所の修正

2. **通信層の抽象化**
```typescript
// 新規作成: src/services/api/index.ts
interface MessageHandler {
  send: (type: string, payload: any) => void;
  receive: (callback: (type: string, payload: any) => void) => void;
}

class WebSocketHandler implements MessageHandler {
  // WebSocket実装
}

class RestHandler implements MessageHandler {
  // REST API実装
}

export const messageHandler = process.env.USE_WEBSOCKET 
  ? new WebSocketHandler()
  : new RestHandler();
```

### Phase 3: スタンドアロン機能の実装

1. **環境判定機能の追加**
```typescript
// webview-ui/src/utils/environment.ts
export const isVsCodeEnv = typeof acquireVsCodeApi === 'function';
export const useVsCodeEnvironment = isVsCodeEnv && process.env.FORCE_STANDALONE !== 'true';
```

2. **設定の外部化**
- 環境変数での制御
- 設定ファイルの作成

### Phase 4: テスト実装

1. **単体テスト**
- 通信層のモック
- 環境判定のテスト
- UI コンポーネントのテスト

2. **統合テスト**
- エンドツーエンドのフロー確認
- WebSocket/REST API 通信テスト

3. **テストカバレッジ目標**
- コアロジック: 90%以上
- UI コンポーネント: 80%以上

### Phase 5: ビルドとデプロイ

1. **ビルド設定の調整**
- webpack/vite の設定調整
- 環境別ビルドの設定

2. **CI/CD パイプラインの構築**
- GitHub Actions の設定
- デプロイ自動化

## 3. 技術的考慮事項

### セキュリティ
- クロスオリジン制限の対応
- API キーの安全な管理
- CORS 設定

### パフォーマンス
- バンドルサイズの最適化
- レンダリングパフォーマンスの確保
- キャッシュ戦略

### 保守性
- コードの分割と整理
- インターフェースの明確な定義
- ドキュメントの整備

## 4. リファクタリング方針

1. **段階的なリファクタリング**
- VS Code 依存部分の特定と分離
- インターフェースの抽象化
- テストカバレッジの維持

2. **コード品質の維持**
- Lint ルールの遵守
- 型安全性の確保
- コードレビューの実施

## 5. アップストリーム更新対応

1. **更新取り込みフロー**
```bash
git fetch upstream
git merge upstream/main
# または
git rebase upstream/main
```

2. **コンフリクト対応方針**
- 変更の影響範囲の確認
- テストの実行による動作確認
- 必要に応じたリファクタリング

## 6. 完了条件

1. スタンドアロンでの起動確認
2. 全テストのパス
3. テストカバレッジ目標の達成
4. ドキュメントの整備完了
5. アップストリーム更新の取り込み確認