# Roo Cline スタンドアロン化実装方針

## 概要

Roo ClineのWebview UIをスタンドアロンなWebアプリケーションとして動作させるための実装方針をまとめます。

## 主な課題と解決策

### 1. VS Code依存の分離

#### 課題
- VS Code APIへの依存（vscode.postMessage等）
- VS Code Webview UI Toolkitの使用
- VS Code固有の型定義

#### 解決策
1. VS Code APIのモック化
```typescript
// src/__mocks__/vscode.ts
export const vscode = {
  postMessage: jest.fn(),
  getState: jest.fn(),
  setState: jest.fn(),
}
```

2. 通信層の抽象化
- WebSocketHandler
- RestHandler
- VS Code通信のラッパー

3. 環境判定による分岐
```typescript
if (typeof acquireVsCodeApi === 'function') {
  // VS Code環境での処理
} else {
  // ブラウザ環境での処理
}
```

### 2. ビルド設定の調整

#### 課題
- CRAの「src外ファイル参照禁止」制限
- Node.js専用モジュールとの互換性
- VSCode関連パッケージの依存解決

#### 解決策
1. config-overrides.jsによるWebpack設定のカスタマイズ
```javascript
module.exports = override(
  addWebpackAlias({
    'roo-shared': path.resolve(__dirname, '..', 'src', 'shared'),
    'vscode': path.resolve(__dirname, 'src', '__mocks__', 'vscode.ts'),
  }),
  // Node.js専用モジュールの除外
  (config) => {
    config.externals = {
      'pdf-parse': 'pdf-parse',
      'mammoth': 'mammoth',
      'isbinaryfile': 'isbinaryfile'
    }
    return config
  }
)
```

2. 共有コードの配置
- src/sharedを webview-ui/src/roo-shared にコピー
- インポートパスの自動調整
- 定期的な同期メカニズム

### 3. 開発環境の整備

#### パッケージ管理
- pnpmの使用
- webview-ui固有の依存関係管理
- devDependenciesの適切な配置

#### ビルドスクリプト
```json
{
  "scripts": {
    "copy-shared": "node scripts/copy-shared.js",
    "start": "pnpm copy-shared && react-app-rewired start",
    "build": "pnpm copy-shared && react-app-rewired build"
  }
}
```

### 4. デプロイメント設定

#### 環境変数
```env
# .env
REACT_APP_COMMUNICATION_MODE=websocket
REACT_APP_WEBSOCKET_URL=ws://localhost:3002
REACT_APP_REST_API_URL=http://localhost:3002
```

#### サーバー設定
- WebSocket/REST API サーバーの構築
- CORSの設定
- エラーハンドリング

## 実装手順

1. 初期セットアップ
```bash
cd webview-ui
pnpm install
node scripts/copy-shared.js
```

2. 開発環境の起動
```bash
# サーバー起動
cd server
pnpm install
pnpm dev

# フロントエンド開発サーバー起動
cd webview-ui
pnpm start
```

3. ビルドとデプロイ
```bash
cd webview-ui
pnpm build
# build/ ディレクトリをデプロイ
```

## 注意点

1. アップストリームとの同期
- src/shared の更新を定期的に確認
- webview-ui/src/roo-shared への反映
- 競合解決の手順確立

2. VS Code拡張との互換性維持
- 通信プロトコルの互換性確保
- 機能の段階的な移行
- テストカバレッジの維持

3. パフォーマンス最適化
- バンドルサイズの監視
- 不要なモジュールの除外
- レンダリング最適化

## 今後の課題

1. モノレポ化の検討
- 共有コードの管理改善
- ビルドプロセスの統合
- 依存関係の一元管理

2. テスト戦略
- ユニットテストの拡充
- E2Eテストの追加
- クロスブラウザテスト

3. CI/CD
- ビルドパイプラインの構築
- 自動デプロイの設定
- 品質チェックの自動化